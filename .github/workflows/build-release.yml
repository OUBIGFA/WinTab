name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - '*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Resolve release version
        id: meta
        shell: pwsh
        run: |
          if ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}"
          }
          else {
            $version = "dev-${{ github.run_number }}"
          }

          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Using version: $version"

      - name: Restore dependencies
        run: dotnet restore WinTab.slnx

      - name: Build
        run: dotnet build WinTab.slnx -c Release --no-restore

      - name: Run tests
        run: dotnet test src/WinTab.Tests/WinTab.Tests.csproj -c Release --no-build

      - name: Publish app
        run: dotnet publish src/WinTab.App/WinTab.App.csproj -c Release -r win-x64 --self-contained false -o publish/win-x64

      - name: Remove debug symbols
        shell: pwsh
        run: |
          Get-ChildItem -Path "publish/win-x64" -Filter "*.pdb" -Recurse | Remove-Item -Force

      - name: Ensure Inno Setup is available
        id: inno
        shell: pwsh
        run: |
          $paths = @(
            "C:\Program Files (x86)\Inno Setup 6\ISCC.exe",
            "C:\Program Files\Inno Setup 6\ISCC.exe"
          )

          $isccPath = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $isccPath) {
            choco install innosetup --no-progress -y
            $isccPath = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1
          }

          if (-not $isccPath) {
            throw "ISCC.exe not found after installation attempt."
          }

          "iscc_path=$isccPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build installer with Inno Setup
        shell: pwsh
        run: |
          & "${{ steps.inno.outputs.iscc_path }}" "/DAppVersion=${{ steps.meta.outputs.version }}" installers/WinTab.iss

      - name: Create portable ZIP
        shell: pwsh
        run: |
          "WinTab Portable Mode - Data is stored in the 'data' folder next to this executable" |
            Out-File -FilePath "publish/win-x64/portable.txt" -Encoding utf8

          $zipPath = "publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip"
          Compress-Archive -Path "publish/win-x64\*" -DestinationPath $zipPath -Force
          Write-Host "Portable ZIP created: $zipPath"

      - name: Generate checksums
        shell: pwsh
        run: |
          $installer = "publish/installer/WinTab_Setup_${{ steps.meta.outputs.version }}.exe"
          $portable = "publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip"

          (Get-FileHash -Algorithm SHA256 $installer).Hash.ToLower() + " *" + [System.IO.Path]::GetFileName($installer) |
            Out-File -FilePath "$installer.sha256" -Encoding ascii

          (Get-FileHash -Algorithm SHA256 $portable).Hash.ToLower() + " *" + [System.IO.Path]::GetFileName($portable) |
            Out-File -FilePath "$portable.sha256" -Encoding ascii

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wintab-${{ steps.meta.outputs.version }}
          path: |
            publish/installer/WinTab_Setup_${{ steps.meta.outputs.version }}.exe
            publish/installer/WinTab_Setup_${{ steps.meta.outputs.version }}.exe.sha256
            publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip
            publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip.sha256

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.version }}
          name: WinTab ${{ steps.meta.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            publish/installer/WinTab_Setup_${{ steps.meta.outputs.version }}.exe
            publish/installer/WinTab_Setup_${{ steps.meta.outputs.version }}.exe.sha256
            publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip
            publish/WinTab_${{ steps.meta.outputs.version }}_portable.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
